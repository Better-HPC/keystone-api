name: QA

on:
  workflow_call:

jobs:
  codeql:
    name: CodeQL
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: /language:${{matrix.language}}

  spectral:
    name: Spectral
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch image artifact
        uses: actions/download-artifact@v3
        with:
          name: keystone-api
          path: /tmp

      - name: Load image
        run: docker load --input /tmp/keystone-api.tar

      - name: Generate OpenAPI schema
        run: docker run keystone-api generateschema >> api.yml

      - name: Upload schema artifact
        uses: actions/upload-artifact@v3
        with:
          name: api-schema
          path: api.yml

      - name: Run Spectral Lint
        uses: addnab/docker-run-action@v3
        with:
          image: stoplight/spectral:latest
          options: -v ${{ github.workspace }}:${{ github.workspace }} -w ${{ github.workspace }}
          run: spectral lint api.yml --fail-severity warn --ruleset .github/spectral.yml

  report-qa-status:
    name: Report QA Status
    runs-on: ubuntu-latest
    needs: [ codeql, spectral ]
    if: always()

    steps:
      - name: Check QA status
        if: ${{ contains(needs.*.result, 'failure') }}
        run: exit 1
